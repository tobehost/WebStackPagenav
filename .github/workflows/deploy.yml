# .github/workflows/deploy.yml
name: 部署到服务器

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  test:
    name: 运行测试
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 设置 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: 运行测试
      run: |
        python -m pytest

  deploy:
    name: 部署应用
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 部署到服务器
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_SSH_PORT || 22 }}
        script: |
          set -e
          echo "开始部署..."
          
          # 1. 进入项目目录
          cd /opt/navpage
          
          # 2. 拉取最新代码
          git fetch --all
          git reset --hard ${{ github.sha }}
          
          # 3. 更新 Python 环境
          echo "更新 Python 环境..."
          python3 -m venv .venv || true
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # 4. 重启应用服务
          echo "重启应用服务..."
          sudo systemctl daemon-reload
          sudo systemctl restart navpage.service
          sleep 2
          
          # 5. 确保 cloudflared 在运行（如果配置为 systemd 服务）
          if systemctl is-active --quiet cloudflared; then
            echo "重启 cloudflared 服务..."
            sudo systemctl restart cloudflared
            sleep 2
          fi
          
          # 6. 验证服务状态
          echo "检查服务状态..."
          sudo systemctl status navpage.service --no-pager | head -n 3
          
          if ! systemctl is-active --quiet navpage.service; then
            echo "错误：navpage 服务未能正常启动"
            sudo journalctl -u navpage.service -n 20 --no-pager
            exit 1
          fi
          
          if systemctl is-active --quiet cloudflared; then
            echo "检查 cloudflared 状态..."
            sudo systemctl status cloudflared --no-pager | head -n 3
            if ! systemctl is-active --quiet cloudflared; then
              echo "警告：cloudflared 服务未能正常启动"
              sudo journalctl -u cloudflared -n 20 --no-pager
            fi
          fi
          
          echo "部署完成!"